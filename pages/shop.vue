<template>
  <div class="container mx-auto px-4 py-8">
    <!-- Pearl Balance Header -->
    <div class="bg-white rounded-lg shadow p-6 mb-8 border-t-4 border-yellow-400">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-2xl font-bold text-gray-900">Pearl Shop</h1>
          <p class="text-gray-600 mt-1">Spend your focus pearls on aquarium items</p>
        </div>
        <div class="text-right">
          <div class="flex items-center text-yellow-500 mb-1">
            <span class="mr-1 text-2xl">🦪</span>
            <span class="text-2xl font-bold">{{ playerPearls }}</span>
          </div>
          <span class="text-sm text-gray-500">Available Pearls</span>
        </div>
      </div>
    </div>

    <!-- Shop Categories -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Fish Section -->
      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-sky-700 mb-4 flex items-center">🐠 Fish</h2>
        <div class="space-y-4">
          <div v-for="fish in availableFish" :key="fish.id" class="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50 transition">
            <div class="flex items-center">
              <img :src="fish.img" :alt="fish.name" class="w-12 h-12 object-contain pixelated mr-3" />
              <div>
                <p class="font-medium">{{ fish.name }}</p>
                <div class="flex items-center text-yellow-500 text-sm">
                  <span class="mr-1">🦪</span>{{ fish.price }}
                </div>
                <div class="text-gray-500 text-xs mt-1">Owned: {{ getItemCount(fish, 'fish') }}/{{fish.maxQuantity}}</div>
              </div>
            </div>
            <button
                :disabled="purchasing || playerPearls < fish.price || getItemCount(fish, 'fish') >= fish.maxQuantity"
                class="bg-sky-600 hover:bg-sky-700 disabled:bg-gray-400 text-white px-3 py-2 rounded text-sm font-medium transition"
                @click="purchaseItem(fish, 'fish')"
            >
              {{ purchasing ? 'Buying...' : (getItemCount(fish, 'fish') >= fish.maxQuantit ? 'Max Owned' : 'Buy') }}
            </button>
          </div>
        </div>
      </div>

      <!-- Plants Section -->
      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-amber-500 mb-4 flex items-center">🐚 Decoration</h2>
        <div class="space-y-4">
          <div v-for="plant in availablePlants" :key="plant.id" class="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50 transition">
            <div class="flex items-center">
              <img :src="plant.img" :alt="plant.name" class="w-12 h-12 object-contain pixelated mr-3" />

              <div>
                <p class="font-medium">{{ plant.name }}</p>
                <div class="flex items-center text-yellow-500 text-sm">

                  <span class="mr-1">🦪</span>{{ plant.price }}
                </div>
                <div class="text-gray-500 text-xs mt-1">Owned: {{ getItemCount(plant, 'plant') }}/ {{plant.maxQuantity}}</div>
              </div>
            </div>
            <button
                :disabled="purchasing || playerPearls < plant.price || getItemCount(plant, 'plant') >= plant.maxQuantity"
                class="bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-3 py-2 rounded text-sm font-medium transition"
                @click="purchaseItem(plant, 'plant')"
            >
              {{ purchasing ? 'Buying...' : (getItemCount(plant, 'plant') >= plant.maxQuantity ? 'Max Owned' : 'Buy') }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Purchase Success Modal -->
    <div v-if="showPurchaseModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
        <div class="text-center mb-6">
          <img
              v-if="lastPurchaseItem.img"
              :src="lastPurchaseItem.img"
              :alt="lastPurchaseItem.name"
              class="mx-auto mt-4 w-20 h-20 pixelated"
          />
          <h3 class="text-xl font-bold text-gray-900">Purchase Successful!</h3>
          <p class="text-gray-600 mt-2">{{ lastPurchaseItem.name }} has been added to your collection.</p>
        </div>
        <div class="flex space-x-3">
          <button
              class="flex-1 flex items-center justify-center bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 rounded-md font-medium"
              @click="closePurchaseModal"
          >
            Continue Shopping
          </button>
          <NuxtLink
              to="/"
              class="flex-1 flex items-center justify-center bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md font-medium"
              @click="closePurchaseModal"
          >
            Go to Aquarium
          </NuxtLink>
        </div>

      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue';
import { useUserStore } from '~/stores/user';

const userStore = useUserStore();
const purchasing = ref(false);
const showPurchaseModal = ref(false);
const lastPurchaseItem = ref({});

const playerPearls = computed(() => userStore.pearls);
import { fishData, plantData } from '~/data/aquarium/items';

const availableFish = ref(fishData.map((fish, i) => ({
  ...fish,
  price: 100 + i * 125,
})));

const availablePlants = ref(plantData
    .map((plant, i) => ({
      ...plant,
      price: 25 + i * 25,
    })));


const purchaseItem = async (item, type) => {
  if (purchasing.value || playerPearls.value < item.price) return;
  
  purchasing.value = true;
  
  try {
    const success = await userStore.purchaseShopItem(item, type, item.price);
    if (success) {
      lastPurchaseItem.value = item;
      showPurchaseModal.value = true;
    }
  } catch (error) {
    console.error('Purchase failed:', error);
  } finally {
    purchasing.value = false;
  }
};

const closePurchaseModal = () => {
  showPurchaseModal.value = false;
};

const getItemCount = (item, type) => {
  if (!userStore.userProfile) return 0;
  
  if (type === 'fish') {
    return userStore.fish.filter(id => id === item.id).length;
  } else if (type === 'plant') {
    return userStore.decorations.filter(id => id === item.id).length;
  } else if (type === 'decoration') {
    return userStore.decorations.filter(id => id === item.id).length;
  }
  
  return 0;
};

onMounted(async () => {
  if (!userStore.userProfile) {
    await userStore.loadUserProfile();
  }
});
</script>

<style scoped>
.pixelated {
  image-rendering: pixelated;
  image-rendering: -moz-crisp-edges;
  image-rendering: crisp-edges;
}
</style>
